<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Case - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --tg-bg: var(--tg-theme-bg-color, #0f0f0f);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-link: var(--tg-theme-link-color, #5ac8fa);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #1a1a1a);
            --tg-accent: #34c759;
            --tg-warning: #ff9500;
            --tg-danger: #ff3b30;
        }

        body {
            background: var(--tg-bg);
            color: var(--tg-text);
            min-height: 100vh;
            padding: 16px 16px 80px 16px;
            line-height: 1.4;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--tg-secondary-bg);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }

        .balance {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-warning);
        }

        .deposit-btn {
            background: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .deposit-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* Promo Banner */
        .promo-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            padding: 14px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .promo-banner::before {
            content: '‚ú®';
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
        }

        .promo-code {
            font-size: 18px;
            font-weight: 700;
            margin: 6px 0;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
            letter-spacing: 1px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-secondary-bg);
            display: flex;
            padding: 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .nav-item.active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cases Grid */
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .cases-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(2, 1fr);
        }

        .case-card {
            background: var(--tg-secondary-bg);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        .case-card:active {
            transform: scale(0.98);
        }

        .case-image {
            width: 60px;
            height: 60px;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .case-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .case-price {
            color: var(--tg-warning);
            font-weight: 700;
            font-size: 16px;
        }

        .case-stats {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 6px;
        }

        /* Tasks List */
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-item {
            background: var(--tg-secondary-bg);
            padding: 16px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .task-reward {
            background: var(--tg-accent);
            color: #000;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .task-btn {
            background: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            transition: all 0.2s ease;
        }

        .task-btn:active {
            transform: scale(0.95);
        }

        .task-btn:disabled {
            background: var(--tg-hint);
            cursor: not-allowed;
        }

        /* Profile */
        .profile-card {
            background: var(--tg-secondary-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--tg-warning);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .ref-section {
            margin-top: 20px;
        }

        .ref-link {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 12px;
            word-break: break-all;
            font-size: 12px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Case Opening Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 16px;
        }

        .modal-content {
            background: var(--tg-secondary-bg);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .items-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin: 20px 0;
            padding: 16px 0;
            scrollbar-width: none;
        }

        .items-scroll::-webkit-scrollbar {
            display: none;
        }

        .scroll-item {
            flex: 0 0 auto;
            width: 70px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .scroll-item.active {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .item-image {
            width: 40px;
            height: 40px;
            margin: 0 auto 6px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(0, 0, 0, 0.2);
        }

        .won-item {
            background: linear-gradient(135deg, var(--tg-warning) 0%, #ff9500 100%);
            padding: 20px;
            border-radius: 16px;
            margin-top: 16px;
            color: #000;
            font-weight: 600;
        }

        .modal-btn {
            background: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px;
            width: calc(100% - 16px);
            transition: all 0.2s ease;
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        /* Rarity Colors */
        .rarity-common { border-left: 3px solid #94a3b8; }
        .rarity-rare { border-left: 3px solid #3b82f6; }
        .rarity-epic { border-left: 3px solid #8b5cf6; }
        .rarity-legendary { border-left: 3px solid #f59e0b; }
        .rarity-mythical { border-left: 3px solid #ef4444; }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--tg-secondary-bg);
            color: var(--tg-text);
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 3000;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive */
        @media (max-width: 360px) {
            .cases-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <div class="balance" id="userBalance">0 –∂–µ—Ç–æ–Ω–æ–≤</div>
                </div>
            </div>
            <button class="deposit-btn" onclick="openDeposit()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        </div>

        <!-- Promo Banner -->
        <div id="promoBanner" class="promo-banner" style="display: none;">
            <div style="font-weight: 600;">üéÅ –ê–ö–¢–ò–í–ù–´–ô –ü–†–û–ú–û–ö–û–î</div>
            <div style="font-size: 12px; opacity: 0.9;">–ë–æ–Ω—É—Å +<span id="promoPercent">0</span>% –∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é</div>
            <div class="promo-code" id="promoCodeDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- Cases Tab -->
        <div id="cases" class="tab-content active">
            <h2 class="section-title">üéÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã</h2>
            <div class="cases-grid" id="casesGrid">
                <!-- Cases loaded by JavaScript -->
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <h2 class="section-title">üìã –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
            <div class="tasks-list" id="tasksList">
                <!-- Tasks loaded by JavaScript -->
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <h2 class="section-title">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="profile-card">
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="statBalance">0</div>
                        <div class="stat-label">–ë–∞–ª–∞–Ω—Å</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statCases">0</div>
                        <div class="stat-label">–ö–µ–π—Å—ã –æ—Ç–∫—Ä—ã—Ç–æ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statRefs">0</div>
                        <div class="stat-label">–†–µ—Ñ–µ—Ä–∞–ª—ã</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statLevel">1</div>
                        <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                    </div>
                </div>
                
                <div class="ref-section">
                    <div style="font-weight: 600; margin-bottom: 8px;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
                    <div class="ref-link" id="refLink">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <button class="task-btn" onclick="copyRefLink()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showTab('cases')">
            <div class="nav-icon">üéÅ</div>
            <div class="nav-label">–ö–µ–π—Å—ã</div>
        </div>
        <div class="nav-item" onclick="showTab('tasks')">
            <div class="nav-icon">üìã</div>
            <div class="nav-label">–ó–∞–¥–∞–Ω–∏—è</div>
        </div>
        <div class="nav-item" onclick="showTab('profile')">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
    </div>

    <!-- Case Opening Modal -->
    <div id="caseOpening" class="modal">
        <div class="modal-content">
            <h3 id="openingCaseName">–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞</h3>
            
            <div class="items-scroll" id="itemsScroll">
                <!-- Items loaded by JavaScript -->
            </div>

            <button class="modal-btn" onclick="startOpening()" id="startBtn">üé≤ –û—Ç–∫—Ä—ã—Ç—å –∑–∞ <span id="casePrice">0</span> –∂–µ—Ç–æ–Ω–æ–≤</button>
            
            <div id="result" style="display: none;">
                <div class="won-item">
                    <div style="font-size: 18px;">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</div>
                    <div id="wonItemName" style="margin: 8px 0;"></div>
                    <div id="wonItemRarity" style="font-size: 12px;"></div>
                </div>
                <button class="modal-btn" onclick="closeCaseOpening()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="depositModal" class="modal">
        <div class="modal-content">
            <h3>üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
            <input type="number" id="depositAmount" placeholder="–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö" 
                   style="width: 100%; padding: 12px; margin: 12px 0; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--tg-text);">
            <input type="text" id="promoCodeInput" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" 
                   style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--tg-text);">
            <div id="promoBonus" style="margin: 8px 0; font-size: 12px;"></div>
            <button class="modal-btn" onclick="processDeposit()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="modal-btn" onclick="closeDeposit()" style="background: rgba(255,255,255,0.1); color: var(--tg-text);">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <script>
        // Telegram Web App initialization
        let tg = window.Telegram.WebApp;
        
        // Initialize Telegram Web App
        tg.expand();
        tg.enableClosingConfirmation();
        tg.BackButton.hide();

        // User data
        let userData = {
            balance: 1500,
            openedCases: 12,
            refCount: 3,
            level: 5,
            refLink: "https://t.me/your_bot?start=ref_" + Math.random().toString(36).substr(2, 9)
        };

        // Promocodes
        const promoCodes = {
            "WELCOME20": { percent: 20, description: "–ù–æ–≤—ã–º –∏–≥—Ä–æ–∫–∞–º" },
            "TELEGRAM30": { percent: 30, description: "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –¥–ª—è Telegram" }
        };

        let currentPromo = "WELCOME20";
        let currentCase = null;
        let isOpening = false;

        // Items database
        const itemsDatabase = [
            { id: 1, name: "üîß –û–±—ã—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", rarity: "common", emoji: "üîß" },
            { id: 2, name: "üì¶ –ü—Ä–æ—Å—Ç–∞—è –∫–æ—Ä–æ–±–∫–∞", rarity: "common", emoji: "üì¶" },
            { id: 3, name: "üíß –ö–∞–ø–ª—è –≤–æ–¥—ã", rarity: "common", emoji: "üíß" },
            { id: 4, name: "üåø –õ–∏—Å—Ç–æ–∫", rarity: "common", emoji: "üåø" },
            { id: 5, name: "üîÆ –ú–∞–≥–∏—á–µ—Å–∫–∏–π —à–∞—Ä", rarity: "rare", emoji: "üîÆ" },
            { id: 6, name: "‚ö° –ú–æ–ª–Ω–∏—è", rarity: "rare", emoji: "‚ö°" },
            { id: 7, name: "üõ°Ô∏è –©–∏—Ç –≤–æ–∏–Ω–∞", rarity: "rare", emoji: "üõ°Ô∏è" },
            { id: 8, name: "üéØ –ú–µ—Ç–∫–∏–π –≥–ª–∞–∑", rarity: "rare", emoji: "üéØ" },
            { id: 9, name: "üî• –û–≥–Ω–µ–Ω–Ω—ã–π –º–µ—á", rarity: "epic", emoji: "üî•" },
            { id: 10, name: "‚ùÑÔ∏è –õ–µ–¥—è–Ω–∞—è –∫–æ—Ä–æ–Ω–∞", rarity: "epic", emoji: "‚ùÑÔ∏è" },
            { id: 11, name: "üíé –ê–ª–º–∞–∑", rarity: "epic", emoji: "üíé" },
            { id: 12, name: "üëë –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π —Å–∫–∏–ø–µ—Ç—Ä", rarity: "epic", emoji: "üëë" },
            { id: 13, name: "üêâ –î—Ä–∞–∫–æ–Ω—å–µ —è–π—Ü–æ", rarity: "legendary", emoji: "üêâ" },
            { id: 14, name: "üåà –†–∞–¥—É–∂–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç", rarity: "legendary", emoji: "üåà" },
            { id: 15, name: "‚öîÔ∏è –ú–µ—á –±–æ–≥–æ–≤", rarity: "legendary", emoji: "‚öîÔ∏è" },
            { id: 16, name: "üåü –ó–≤–µ–∑–¥–∞ —Å—É–¥—å–±—ã", rarity: "mythical", emoji: "üåü" }
        ];

        // Cases database
        const casesDatabase = [
            {
                id: 1,
                name: "üì¶ –ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å",
                price: 100,
                emoji: "üì¶",
                items: itemsDatabase.filter(item => ["common", "rare"].includes(item.rarity))
            },
            {
                id: 2,
                name: "üíé –ü—Ä–µ–º–∏—É–º –∫–µ–π—Å",
                price: 500,
                emoji: "üíé",
                items: itemsDatabase.filter(item => ["rare", "epic"].includes(item.rarity))
            },
            {
                id: 3,
                name: "üî• –û–≥–Ω–µ–Ω–Ω—ã–π –∫–µ–π—Å",
                price: 1000,
                emoji: "üî•",
                items: itemsDatabase.filter(item => ["epic", "legendary"].includes(item.rarity))
            },
            {
                id: 4,
                name: "üëë –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–µ–π—Å",
                price: 5000,
                emoji: "üëë",
                items: itemsDatabase.filter(item => ["legendary", "mythical"].includes(item.rarity))
            }
        ];

        // Initialize app
        function initApp() {
            loadUserData();
            setupTelegramUser();
            loadPromoBanner();
            loadCases();
            loadTasks();
            updateProfile();
        }

        function setupTelegramUser() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                document.getElementById('userName').textContent = user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('userAvatar').textContent = user.first_name?.[0] || 'U';
            }
        }

        function loadUserData() {
            document.getElementById('userBalance').textContent = userData.balance.toLocaleString() + ' –∂–µ—Ç–æ–Ω–æ–≤';
        }

        function loadPromoBanner() {
            const promo = promoCodes[currentPromo];
            if (promo) {
                document.getElementById('promoBanner').style.display = 'block';
                document.getElementById('promoPercent').textContent = promo.percent;
                document.getElementById('promoCodeDisplay').textContent = currentPromo;
            }
        }

        function loadCases() {
            const grid = document.getElementById('casesGrid');
            grid.innerHTML = casesDatabase.map(caseItem => `
                <div class="case-card rarity-${caseItem.id === 4 ? 'legendary' : caseItem.id === 3 ? 'epic' : caseItem.id === 2 ? 'rare' : 'common'}" 
                     onclick="selectCase(${caseItem.id})">
                    <div class="case-image">${caseItem.emoji}</div>
                    <div class="case-name">${caseItem.name}</div>
                    <div class="case-price">${caseItem.price.toLocaleString()} –∂–µ—Ç–æ–Ω–æ–≤</div>
                    <div class="case-stats">${caseItem.items.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                </div>
            `).join('');
        }

        function loadTasks() {
            const tasks = [
                { title: "üì± –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª", reward: 50, completed: false },
                { title: "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞", reward: 100, completed: false },
                { title: "üéÆ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥", reward: 10, completed: true },
                { title: "üíé –û—Ç–∫—Ä–æ–π—Ç–µ 3 –∫–µ–π—Å–∞", reward: 150, completed: false }
            ];

            document.getElementById('tasksList').innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-header">
                        <div style="font-weight: 600;">${task.title}</div>
                        <div class="task-reward">+${task.reward}</div>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8;">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ –Ω–∞–≥—Ä–∞–¥—É</div>
                    <button class="task-btn" onclick="completeTask(this)" ${task.completed ? 'disabled' : ''}>
                        ${task.completed ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–í—ã–ø–æ–ª–Ω–∏—Ç—å'}
                    </button>
                </div>
            `).join('');
        }

        function updateProfile() {
            document.getElementById('statBalance').textContent = userData.balance.toLocaleString();
            document.getElementById('statCases').textContent = userData.openedCases;
            document.getElementById('statRefs').textContent = userData.refCount;
            document.getElementById('statLevel').textContent = userData.level;
            document.getElementById('refLink').textContent = userData.refLink;
        }

        function showTab(tabName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[tabName === 'cases' ? 0 : tabName === 'tasks' ? 1 : 2].classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        function selectCase(caseId) {
            currentCase = casesDatabase.find(c => c.id === caseId);
            
            if (userData.balance < currentCase.price) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∂–µ—Ç–æ–Ω–æ–≤');
                return;
            }

            document.getElementById('openingCaseName').textContent = currentCase.name;
            document.getElementById('casePrice').textContent = currentCase.price.toLocaleString();
            document.getElementById('caseOpening').style.display = 'flex';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            // Load items for scroll
            const scroll = document.getElementById('itemsScroll');
            scroll.innerHTML = currentCase.items.map(item => `
                <div class="scroll-item rarity-${item.rarity}">
                    <div class="item-image">${item.emoji}</div>
                    <div style="font-size: 9px;">${item.name.split(' ')[0]}</div>
                </div>
            `).join('');
        }

        function startOpening() {
            if (isOpening) return;
            isOpening = true;

            userData.balance -= currentCase.price;
            userData.openedCases++;
            updateProfile();
            loadUserData();

            document.getElementById('startBtn').style.display = 'none';

            const scroll = document.getElementById('itemsScroll');
            const items = scroll.children;
            const wonItem = currentCase.items[Math.floor(Math.random() * currentCase.items.length)];
            
            let currentIndex = 0;
            const duration = 3000;
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Fast then slow animation
                const speed = progress < 0.7 ? 8 : 2;
                currentIndex = (currentIndex + speed) % items.length;

                // Update active item
                Array.from(items).forEach((item, index) => {
                    item.classList.toggle('active', Math.floor(currentIndex) === index);
                });

                if (progress < 1) {
                    setTimeout(animate, 50);
                } else {
                    // Show result
                    setTimeout(() => showResult(wonItem), 500);
                }
            }

            animate();
        }

        function showResult(wonItem) {
            document.getElementById('wonItemName').textContent = wonItem.name;
            document.getElementById('wonItemRarity').textContent = `–†–µ–¥–∫–æ—Å—Ç—å: ${getRarityName(wonItem.rarity)}`;
            document.getElementById('result').style.display = 'block';

            // Add reward based on rarity
            const rewards = { common: 10, rare: 25, epic: 100, legendary: 500, mythical: 2000 };
            userData.balance += rewards[wonItem.rarity];
            updateProfile();
            loadUserData();

            isOpening = false;
            showToast(`üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${wonItem.name} (+${rewards[wonItem.rarity]} –∂–µ—Ç–æ–Ω–æ–≤)`);
        }

        function getRarityName(rarity) {
            const names = { common: '–û–±—ã—á–Ω–∞—è', rare: '–†–µ–¥–∫–∞—è', epic: '–≠–ø–∏—á–µ—Å–∫–∞—è', legendary: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è', mythical: '–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è' };
            return names[rarity];
        }

        function closeCaseOpening() {
            document.getElementById('caseOpening').style.display = 'none';
            currentCase = null;
        }

        function completeTask(button) {
            const reward = parseInt(button.parentElement.querySelector('.task-reward').textContent);
            userData.balance += reward;
            button.textContent = '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ';
            button.disabled = true;
            updateProfile();
            loadUserData();
            showToast(`‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${reward} –∂–µ—Ç–æ–Ω–æ–≤`);
        }

        function openDeposit() {
            document.getElementById('depositModal').style.display = 'flex';
        }

        function closeDeposit() {
            document.getElementById('depositModal').style.display = 'none';
        }

        function processDeposit() {
            const amount = parseInt(document.getElementById('depositAmount').value);
            const promoCode = document.getElementById('promoCodeInput').value.toUpperCase();
            
            if (!amount || amount < 10) {
                showToast('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 10 —Ä—É–±–ª–µ–π');
                return;
            }

            let bonus = 0;
            if (promoCode && promoCodes[promoCode]) {
                bonus = Math.floor(amount * promoCodes[promoCode].percent / 100);
            }

            const total = amount + bonus;
            userData.balance += total;
            
            showToast(`‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–æ ${total} –∂–µ—Ç–æ–Ω–æ–≤!${bonus ? ` (+${bonus} –±–æ–Ω—É—Å)` : ''}`);
            updateProfile();
            loadUserData();
            closeDeposit();
        }

        function copyRefLink() {
            navigator.clipboard.writeText(userData.refLink);
            showToast('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Handle Telegram theme changes
        tg.onEvent('themeChanged', () => {
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#0f0f0f';
        });
    </script>
</body>
</html>
